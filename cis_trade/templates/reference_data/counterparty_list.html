{% extends 'base.html' %}
{% load static %}

{% block title %}Counterparties - CisTrade{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="#">Reference Data</a></li>
    <li class="breadcrumb-item active">Counterparties</li>
{% endblock %}

{% block content %}
<div class="counterparty-list-container">
    <!-- Page Header -->
    <div class="content-header">
        <h1 class="content-title">
            <i class="bi bi-building text-primary"></i> Counterparties
        </h1>
        <p class="content-subtitle">Manage counterparty reference data from Kudu</p>
    </div>

    <!-- Search & Filter Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-funnel"></i> Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <form method="get" action="{% url 'reference_data:counterparty_list' %}" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" name="search" value="{{ search_query }}"
                               placeholder="Search by code, name, or city...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select class="form-select" name="type">
                        <option value="">All Types</option>
                        <option value="BANK" {% if type_filter == 'BANK' %}selected{% endif %}>Bank</option>
                        <option value="BROKER" {% if type_filter == 'BROKER' %}selected{% endif %}>Broker</option>
                        <option value="CORPORATE" {% if type_filter == 'CORPORATE' %}selected{% endif %}>Corporate</option>
                        <option value="INSTITUTIONAL" {% if type_filter == 'INSTITUTIONAL' %}selected{% endif %}>Institutional</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Risk Category</label>
                    <select class="form-select" name="risk">
                        <option value="">All Risks</option>
                        <option value="LOW" {% if risk_filter == 'LOW' %}selected{% endif %}>Low</option>
                        <option value="MEDIUM" {% if risk_filter == 'MEDIUM' %}selected{% endif %}>Medium</option>
                        <option value="HIGH" {% if risk_filter == 'HIGH' %}selected{% endif %}>High</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">All</option>
                        <option value="ACTIVE" {% if status_filter == 'ACTIVE' %}selected{% endif %}>Active</option>
                        <option value="INACTIVE" {% if status_filter == 'INACTIVE' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </form>
            {% if search_query or type_filter or risk_filter or status_filter %}
                <div class="mt-3 pt-3 border-top">
                    <a href="{% url 'reference_data:counterparty_list' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Clear All Filters
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Counterparties Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                Counterparty List
                <span class="badge badge-primary ms-2">{{ counterparties|length }} counterparties</span>
            </h5>
            <a href="?export=csv&{{ request.GET.urlencode }}" class="btn btn-sm btn-success">
                <i class="bi bi-download"></i> Download CSV
            </a>
        </div>
        <div class="card-body p-0">
            {% if counterparties %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 8%;">Code</th>
                                <th style="width: 15%;">Name</th>
                                <th style="width: 12%;">Short Name</th>
                                <th style="width: 10%;">Type</th>
                                <th style="width: 12%;">City/Country</th>
                                <th style="width: 15%;">Email</th>
                                <th style="width: 10%;">Phone</th>
                                <th style="width: 8%;">Risk</th>
                                <th style="width: 10%;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cp in counterparties %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ cp.code }}</strong>
                                </td>
                                <td>
                                    <strong>{{ cp.name }}</strong>
                                    {% if cp.legal_name and cp.legal_name != cp.name %}
                                        <br><small class="text-muted">{{ cp.legal_name|truncatewords:4 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ cp.short_name|default:"-" }}</td>
                                <td>
                                    {% if cp.counterparty_type == 'BANK' %}
                                        <span class="badge badge-primary">
                                            <i class="bi bi-bank"></i> Bank
                                        </span>
                                    {% elif cp.counterparty_type == 'BROKER' %}
                                        <span class="badge badge-info">
                                            <i class="bi bi-graph-up"></i> Broker
                                        </span>
                                    {% elif cp.counterparty_type == 'CORPORATE' %}
                                        <span class="badge badge-warning">
                                            <i class="bi bi-building"></i> Corporate
                                        </span>
                                    {% elif cp.counterparty_type == 'INSTITUTIONAL' %}
                                        <span class="badge badge-success">
                                            <i class="bi bi-briefcase"></i> Institutional
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ cp.counterparty_type|default:"-" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ cp.city|default:"-" }}</div>
                                    <small class="text-muted">{{ cp.country|default:"-" }}</small>
                                </td>
                                <td>
                                    {% if cp.email %}
                                        <a href="mailto:{{ cp.email }}" class="text-decoration-none" style="font-size: var(--font-size-sm);">
                                            <i class="bi bi-envelope"></i> {{ cp.email|truncatewords:1 }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cp.phone %}
                                        <small>{{ cp.phone }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cp.risk_category == 'LOW' %}
                                        <span class="badge badge-success">Low</span>
                                    {% elif cp.risk_category == 'MEDIUM' %}
                                        <span class="badge badge-warning">Medium</span>
                                    {% elif cp.risk_category == 'HIGH' %}
                                        <span class="badge badge-danger">High</span>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ cp.risk_category|default:"-" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cp.is_active %}
                                        <span class="badge badge-success">Active</span>
                                    {% else %}
                                        <span class="badge badge-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5" style="color: var(--gray-500);">
                    <i class="bi bi-building" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3 mb-0">No counterparties found</p>
                    {% if search_query or type_filter or risk_filter or status_filter %}
                        <p class="text-muted">Try adjusting your filters</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row g-4 mt-2">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-bank text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-0">{{ stats.banks|default:0 }}</h3>
                    <small class="text-muted">Banks</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-0">{{ stats.brokers|default:0 }}</h3>
                    <small class="text-muted">Brokers</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-building text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-0">{{ stats.corporates|default:0 }}</h3>
                    <small class="text-muted">Corporates</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-briefcase text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-0">{{ stats.institutional|default:0 }}</h3>
                    <small class="text-muted">Institutional</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mt-4">
        <i class="bi bi-info-circle"></i>
        <strong>Note:</strong> Counterparty data is fetched from Kudu/Impala in real-time.
        Risk categories are reviewed quarterly. Contact compliance for risk category changes.
    </div>
</div>
{% endblock %}
