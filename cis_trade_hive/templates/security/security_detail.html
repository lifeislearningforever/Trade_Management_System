{% extends 'base.html' %}
{% load static %}

{% block title %}{{ security.security_name }} - CisTrade{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{% url 'security:list' %}">Securities</a></li>
    <li class="breadcrumb-item active">{{ security.security_name|truncatewords:3 }}</li>
{% endblock %}

{% block content %}
<div class="security-detail-container">
    <!-- Page Header -->
    <div class="content-header">
        <div>
            <h1 class="content-title">
                <i class="bi bi-shield-check text-primary"></i> {{ security.security_name }}
            </h1>
            <p class="content-subtitle">ISIN: {{ security.isin|default:"N/A" }}</p>
        </div>
        <div>
            <!-- Workflow Action Buttons -->
            {% if security.status == 'DRAFT' or security.status == 'REJECTED' %}
                <a href="{% url 'security:edit' security.security_id %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <form method="post" action="{% url 'security:submit' security.security_id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" onclick="return confirm('Submit for approval?')">
                        <i class="bi bi-send"></i> Submit for Approval
                    </button>
                </form>
            {% elif security.status == 'PENDING_APPROVAL' %}
                <form method="post" action="{% url 'security:approve' security.security_id %}" class="d-inline">
                    {% csrf_token %}
                    <div class="d-inline-flex gap-2">
                        <input type="text" name="comments" class="form-control" placeholder="Approval comments (optional)" style="width: 300px;">
                        <button type="submit" class="btn btn-success" onclick="return confirm('Approve this security?')">
                            <i class="bi bi-check-circle"></i> Approve
                        </button>
                    </div>
                </form>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
                    <i class="bi bi-x-circle"></i> Reject
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Status Card -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Status</h6>
                    {% if security.status == 'DRAFT' %}
                        <span class="badge badge-secondary fs-6">Draft</span>
                    {% elif security.status == 'PENDING_APPROVAL' %}
                        <span class="badge badge-warning fs-6">Pending Approval</span>
                    {% elif security.status == 'ACTIVE' %}
                        <span class="badge badge-success fs-6">Active</span>
                    {% elif security.status == 'REJECTED' %}
                        <span class="badge badge-danger fs-6">Rejected</span>
                    {% elif security.status == 'INACTIVE' %}
                        <span class="badge badge-dark fs-6">Inactive</span>
                    {% else %}
                        <span class="badge badge-secondary fs-6">{{ security.status|default:"Unknown" }}</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Active</h6>
                    {% if security.is_active %}
                        <i class="bi bi-check-circle-fill text-success fs-5"></i> Yes
                    {% else %}
                        <i class="bi bi-x-circle-fill text-danger fs-5"></i> No
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Currency</h6>
                    <span class="badge badge-info fs-6">{{ security.currency_code|default:"N/A" }}</span>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Price</h6>
                    <strong class="fs-5">{{ security.price|floatformat:4|default:"-" }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Details -->
    <div class="row">
        <!-- Core Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Core Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 45%;">Security Name:</th>
                            <td><strong>{{ security.security_name }}</strong></td>
                        </tr>
                        <tr>
                            <th>ISIN:</th>
                            <td>{{ security.isin|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Description:</th>
                            <td>{{ security.security_description|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Security Type:</th>
                            <td>{{ security.security_type|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Investment Type:</th>
                            <td>{{ security.investment_type|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Industry:</th>
                            <td>{{ security.industry|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Issuer:</th>
                            <td>{{ security.issuer|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Ticker:</th>
                            <td>{{ security.ticker|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Quoted/Unquoted:</th>
                            <td>{{ security.quoted_unquoted|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Geographic & Exchange Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-globe"></i> Geographic & Exchange Info</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 45%;">Country of Incorporation:</th>
                            <td>{{ security.country_of_incorporation|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Country of Issue:</th>
                            <td>{{ security.country_of_issue|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Country of Exchange:</th>
                            <td>{{ security.country_of_exchange|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Country of Primary Exchange:</th>
                            <td>{{ security.country_of_primary_exchange|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Exchange Code:</th>
                            <td>{{ security.exchange_code|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Currency Code:</th>
                            <td>{{ security.currency_code|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Shares Outstanding:</th>
                            <td>{{ security.shares_outstanding|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Trading & Pricing Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up"></i> Trading & Pricing</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 45%;">Price:</th>
                            <td>{{ security.price|floatformat:4|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Price Date:</th>
                            <td>{{ security.price_date|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Price Source:</th>
                            <td>{{ security.price_source|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Beta:</th>
                            <td>{{ security.beta|floatformat:2|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>PAR Value:</th>
                            <td>{{ security.par_value|floatformat:2|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Regulatory & Management Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-shield-fill-check"></i> Regulatory & Management</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 45%;">BWCIIF:</th>
                            <td>{{ security.bwciif|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>BWCIIF Others:</th>
                            <td>{{ security.bwciif_others|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Issuer Type:</th>
                            <td>{{ security.issuer_type|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Approved S32:</th>
                            <td>{{ security.approved_s32|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>BASEL IV - FUND:</th>
                            <td>{{ security.basel_iv_fund|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Business Unit Head:</th>
                            <td>{{ security.business_unit_head|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Core/Non-core:</th>
                            <td>{{ security.core_non_core|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Fund / Index Fund:</th>
                            <td>{{ security.fund_index_fund|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Management Limit Classification:</th>
                            <td>{{ security.management_limit_classification|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>MAS 643 Entity Type:</th>
                            <td>{{ security.mas_643_entity_type|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Person In Charge:</th>
                            <td>{{ security.person_in_charge|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Substantial >10%:</th>
                            <td>{{ security.substantial_gt_10_percent|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Relative Index:</th>
                            <td>{{ security.relative_index|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Fin/Non-fin IND:</th>
                            <td>{{ security.fin_non_fin_ind|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Information -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="bi bi-diagram-3"></i> Workflow Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Created By</h6>
                    <p><i class="bi bi-person-circle"></i> {{ security.created_by|default:"-" }}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Created At</h6>
                    <p><i class="bi bi-clock-history"></i> {{ security.created_at|default:"-" }}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Last Updated At</h6>
                    <p><i class="bi bi-clock-history"></i> {{ security.updated_at|default:"-" }}</p>
                </div>
            </div>
            {% if security.submitted_by %}
            <div class="row mt-3">
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Submitted By</h6>
                    <p><i class="bi bi-person-check"></i> {{ security.submitted_by }}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Submitted At</h6>
                    <p><i class="bi bi-clock-history"></i> {{ security.submitted_for_approval_at|default:"-" }}</p>
                </div>
            </div>
            {% endif %}
            {% if security.reviewed_by %}
            <div class="row mt-3">
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Reviewed By</h6>
                    <p><i class="bi bi-person-check-fill"></i> {{ security.reviewed_by }}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Reviewed At</h6>
                    <p><i class="bi bi-clock-history"></i> {{ security.reviewed_at|default:"-" }}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted mb-2">Review Comments</h6>
                    <p><i class="bi bi-chat-square-text"></i> {{ security.review_comments|default:"-" }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- History -->
    {% if history %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="bi bi-clock-history"></i> Change History</h5>
        </div>
        <div class="card-body">
            <div class="timeline" style="max-height: 400px; overflow-y: auto;">
                {% for record in history %}
                <div class="timeline-item mb-3">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            {% if record.action == 'CREATE' %}
                                <i class="bi bi-plus-circle-fill text-primary fs-4"></i>
                            {% elif record.action == 'UPDATE' %}
                                <i class="bi bi-pencil-fill text-info fs-4"></i>
                            {% elif record.action == 'SUBMIT' %}
                                <i class="bi bi-send-fill text-warning fs-4"></i>
                            {% elif record.action == 'APPROVE' %}
                                <i class="bi bi-check-circle-fill text-success fs-4"></i>
                            {% elif record.action == 'REJECT' %}
                                <i class="bi bi-x-circle-fill text-danger fs-4"></i>
                            {% else %}
                                <i class="bi bi-circle-fill text-secondary fs-4"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">{{ record.action }} by {{ record.performed_by }}</h6>
                            <p class="text-muted mb-1" style="font-size: 0.85rem;">
                                <i class="bi bi-clock"></i> {{ record.performed_at|default:"-" }}
                            </p>
                            {% if record.comments %}
                            <p class="mb-1"><strong>Comments:</strong> {{ record.comments }}</p>
                            {% endif %}
                            {% if record.changes %}
                            <details>
                                <summary class="text-primary" style="cursor: pointer;">View Changes</summary>
                                <pre class="bg-light p-2 mt-2" style="font-size: 0.75rem;">{{ record.changes }}</pre>
                            </details>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <hr>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="d-flex gap-2">
        <a href="{% url 'security:list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<!-- Reject Security Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="bi bi-x-circle"></i> Reject Security
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'security:reject' security.security_id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will reject security <strong>{{ security.security_name }}</strong>.
                        The Maker will need to address your concerns and resubmit.
                    </div>
                    <div class="mb-3">
                        <label for="comments" class="form-label required">Rejection Comments</label>
                        <textarea class="form-control" id="comments" name="comments" rows="4" required
                                  placeholder="Enter detailed reason for rejection..."></textarea>
                        <div class="form-text">
                            Providing clear rejection reasons helps the Maker address issues effectively.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> Reject Security
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.required::after {
    content: " *";
    color: red;
}
</style>
{% endblock %}
